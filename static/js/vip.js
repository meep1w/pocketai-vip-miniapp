/* ================= I18N ================= */
const I18N = {
    en: {
        "menu.title":"Menu","menu.stats":"Your Statistics","menu.language":"Choose Language","menu.theme":"Theme",
        "btn.close":"Close","btn.generate":"Generate signal","btn.reset":"Reset","btn.repeat":"Repeat",
        "label.select_instrument":"Select instrument","ph.select_instrument":"Select instrument",
        "label.expiration_time":"Expiration time","ph.expiration_time":"Select the time of the transaction",
        "instr.title":"Select instrument","instr.categories":"CATEGORIES",
        "instr.currencies":"Currencies","instr.crypto":"Cryptocurrencies","instr.stocks":"Stocks","instr.commodities":"Commodities","instr.indices":"Indices",
        "expire.title":"Expiration time","signal.title":"Signal","vip.idle":"Tap “Generate signal”","modal.q":"Model: TESSA Quantum",
        "vip.ta":"Technical analysis","vip.ta_sub":"Indicators & S/R",
        "vip.patterns":"Patterns recognition","vip.patterns_sub":"Trends & figures",
        "vip.math":"Mathematical calculations","vip.math_sub":"Probabilities & risks",
        "vip.generation":"Signal generation","vip.generation_sub":"Final assembling",
        "welcome.title":"Welcome, Platinum!","welcome.text":"You are now a Platinum client. Thanks for being with us! Enjoy higher accuracy, trade wisely and use your status benefits.","welcome.cta":"Continue",
        "vip.market":"Market:","vip.time":"Time:","vip.pair":"Pair:","vip.confidence":"Confidence:","vip.strength":"Strength:","vip.valid_until":"Valid until:",
        "vip.accuracy":"accuracy","vip.volume":"volume","vip.risk":"risk",
        "progress.analyzing":"Analyzing…","progress.step1":"Technical analysis","progress.step2":"Patterns recognition","progress.step3":"Math models","progress.step4":"Signal generation",
        "stats.title":"Your Statistics","stats.tariff":"Your tariff:","stats.received":"Signals received:","stats.accuracy":"Signal accuracy:"
    },
    ru: {
        "menu.title":"Меню","menu.stats":"Ваша статистика","menu.language":"Выбор языка","menu.theme":"Тема",
        "btn.close":"Закрыть","btn.generate":"Сгенерировать сигнал","btn.reset":"Сбросить","btn.repeat":"Повторить",
        "label.select_instrument":"Выберите инструмент","ph.select_instrument":"Выберите инструмент",
        "label.expiration_time":"Время экспирации","ph.expiration_time":"Выберите время сделки",
        "instr.title":"Выберите инструмент","instr.categories":"КАТЕГОРИИ",
        "instr.currencies":"Валюты","instr.crypto":"Криптовалюты","instr.stocks":"Акции","instr.commodities":"Сырьё","instr.indices":"Индексы",
        "expire.title":"Время экспирации","signal.title":"Сигнал","vip.idle":"Нажмите «Сгенерировать сигнал»","modal.q":"Модель: TESSA Quantum",
        "vip.ta":"Технический анализ","vip.ta_sub":"Индикаторы и уровни S/R",
        "vip.patterns":"Распознавание паттернов","vip.patterns_sub":"Тренды и фигуры",
        "vip.math":"Математические расчёты","vip.math_sub":"Вероятности и риски",
        "vip.generation":"Генерация сигнала","vip.generation_sub":"Финальная сборка",
        "welcome.title":"Добро пожаловать, Platinum!","welcome.text":"Вы теперь Platinum-клиент. Спасибо, что с нами! Получайте более точные сигналы, торгуйте аккуратно и используйте преимущества вашего статуса.","welcome.cta":"Продолжить",
        "vip.market":"Рынок:","vip.time":"Время:","vip.pair":"Пара:","vip.confidence":"Уверенность:","vip.strength":"Сила:","vip.valid_until":"Действует до:",
        "vip.accuracy":"точность","vip.volume":"объём","vip.risk":"риск",
        "progress.analyzing":"Анализ…","progress.step1":"Технический анализ","progress.step2":"Распознавание паттернов","progress.step3":"Математические модели","progress.step4":"Генерация сигнала",
        "stats.title":"Ваша статистика","stats.tariff":"Ваш тариф:","stats.received":"Сигналов получено:","stats.accuracy":"Средняя точность:"
    },
    es: {
        "menu.title":"Menú","menu.stats":"Tus estadísticas","menu.language":"Elegir idioma","menu.theme":"Tema",
        "btn.close":"Cerrar","btn.generate":"Generar señal","btn.reset":"Restablecer","btn.repeat":"Repetir",
        "label.select_instrument":"Selecciona instrumento","ph.select_instrument":"Selecciona instrumento",
        "label.expiration_time":"Tiempo de expiración","ph.expiration_time":"Selecciona el tiempo de la operación",
        "instr.title":"Selecciona instrumento","instr.categories":"CATEGORÍAS",
        "instr.currencies":"Divisas","instr.crypto":"Criptomonedas","instr.stocks":"Acciones","instr.commodities":"Materias primas","instr.indices":"Índices",
        "expire.title":"Tiempo de expiración","signal.title":"Señal","vip.idle":"Pulsa «Generar señal»","modal.q":"Modelo: TESSA Quantum",
        "vip.ta":"Análisis técnico","vip.ta_sub":"Indicadores y S/R",
        "vip.patterns":"Reconocimiento de patrones","vip.patterns_sub":"Tendencias y figuras",
        "vip.math":"Cálculos matemáticos","vip.math_sub":"Probabilidades y riesgos",
        "vip.generation":"Generación de señal","vip.generation_sub":"Montaje final",
        "welcome.title":"¡Bienvenido, Platinum!","welcome.text":"Ahora eres cliente Platinum. ¡Gracias por estar con nosotros! Disfruta de mayor precisión, opera con cuidado y usa tus beneficios.","welcome.cta":"Continuar",
        "vip.market":"Mercado:","vip.time":"Tiempo:","vip.pair":"Par:","vip.confidence":"Confianza:","vip.strength":"Fuerza:","vip.valid_until":"Válido hasta:",
        "vip.accuracy":"precisión","vip.volume":"volumen","vip.risk":"riesgo",
        "progress.analyzing":"Analizando…","progress.step1":"Análisis técnico","progress.step2":"Patrones","progress.step3":"Modelos matemáticos","progress.step4":"Generación de señal",
        "stats.title":"Tus estadísticas","stats.tariff":"Tu plan:","stats.received":"Señales recibidas:","stats.accuracy":"Precisión media:"
    },
    hi: {
        "menu.title":"मेन्यू","menu.stats":"आपकी सांख्यिकी","menu.language":"भाषा चुनें","menu.theme":"थीम",
        "btn.close":"बंद करें","btn.generate":"सिग्नल जनरेट करें","btn.reset":"रीसेट","btn.repeat":"दोहराएँ",
        "label.select_instrument":"इंस्ट्रूमेंट चुनें","ph.select_instrument":"इंस्ट्रूमेंट चुनें",
        "label.expiration_time":"एक्सपायरी समय","ph.expiration_time":"ट्रांज़ैक्शन का समय चुनें",
        "instr.title":"इंस्ट्रूमेंट चुनें","instr.categories":"श्रेणियाँ",
        "instr.currencies":"मुद्राएँ","instr.crypto":"क्रिप्टो","instr.stocks":"स्टॉक्स","instr.commodities":"कमोडिटीज़","instr.indices":"इंडाइसेज़",
        "expire.title":"एक्सपायरी समय","signal.title":"सिग्नल","vip.idle":"«सिग्नल जनरेट करें» दबाएँ","modal.q":"मॉडल: TESSA Quantum",
        "vip.ta":"टेक्निकल एनालिसिस","vip.ta_sub":"इंडिकेटर्स व S/R",
        "vip.patterns":"पैटर्न पहचान","vip.patterns_sub":"ट्रेंड व फिगर्स",
        "vip.math":"गणितीय गणनाएँ","vip.math_sub":"प्रायिकताएँ व जोखिम",
        "vip.generation":"सिग्नल जेनरेशन","vip.generation_sub":"अंतिम असेंबली",
        "welcome.title":"स्वागत है, Platinum!","welcome.text":"अब आप Platinum क्लाइंट हैं। हमारे साथ रहने के लिए धन्यवाद! अधिक सटीकता पाएं, समझदारी से ट्रेड करें और अपने स्टेटस के फायदे लें।","welcome.cta":"जारी रखें",
        "vip.market":"मार्केट:","vip.time":"समय:","vip.pair":"पेयर:","vip.confidence":"कॉन्फिडेंस:","vip.strength":"स्ट्रेंथ:","vip.valid_until":"तक वैध:",
        "vip.accuracy":"सटीकता","vip.volume":"वॉल्यूम","vip.risk":"रिस्क",
        "progress.analyzing":"विश्लेषण…","progress.step1":"टेक्निकल एनालिसिस","progress.step2":"पैटर्न्स","progress.step3":"गणितीय मॉडल","progress.step4":"सिग्नल जेनरेशन",
        "stats.title":"आपकी सांख्यिकी","stats.tariff":"आपका टैरिफ:","stats.received":"प्राप्त सिग्नल:","stats.accuracy":"औसत सटीकता:"
    }
};

const KEYS = {
    THEME:"vip_theme",
    LANG:"vip_lang",
    FIELDS:"vip_fields",
    SIGNAL:"vip_signal",
    WELCOME_SHOWN:"vip_welcome_shown",
    STATS:"vip_stats"
};

/* ================= Lang & Theme ================= */
function getLang(){
    const saved = localStorage.getItem(KEYS.LANG);
    if (saved) return saved;
    localStorage.setItem(KEYS.LANG, 'en'); // default = EN
    return 'en';
}
function t(){ return I18N[getLang()] || I18N.en; }

function applyI18n(lang){
    const d = I18N[lang] || I18N.en;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if (!k || d[k] == null) return;
        if (/^(INPUT|TEXTAREA)$/.test(el.tagName)) el.setAttribute('placeholder', d[k]);
        else el.textContent = d[k];
    });

    // placeholders для полей, если пустые
    const f = getFields();
    if (!f.instrument) {
        const ph = document.querySelector('#field-instrument .ui-field__placeholder');
        if (ph) ph.textContent = d['ph.select_instrument'];
    }
    if (!f.expiration) {
        const ph = document.querySelector('#field-expiration .ui-field__placeholder');
        if (ph) ph.textContent = d['ph.expiration_time'];
    }
}

function getPreferredTheme(){
    try { if (window.Telegram?.WebApp?.colorScheme) return window.Telegram.WebApp.colorScheme; } catch(e){}
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}
function setHtmlTheme(mode){
    const eff = (mode==='default') ? getPreferredTheme() : mode;
    document.documentElement.setAttribute('data-theme', eff);
    const logo = document.getElementById('logoImg');
    if (logo){
        const light = logo.getAttribute('data-src-light');
        const dark  = logo.getAttribute('data-src-dark');
        if (light && dark) logo.src = eff==='light' ? light : dark;
    }
}

/* ================= Sidebar & Modals ================= */
const burger = document.getElementById('burgerBtn');
const sidebar = document.getElementById('sidebar');
document.getElementById('closeSidebar')?.addEventListener('click', ()=>sidebar?.classList.remove('open'));
burger?.addEventListener('click', ()=>sidebar?.classList.add('open'));
document.addEventListener('click', (e)=>{
    if (!sidebar) return;
    if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !burger.contains(e.target)){
        sidebar.classList.remove('open');
    }
});

function openModal(id){ document.getElementById(id)?.classList.add('open'); }
function closeModal(id){ document.getElementById(id)?.classList.remove('open'); }
document.querySelectorAll('.modal [data-close-modal]').forEach(el=>{
    el.addEventListener('click', ()=> closeModal(el.closest('.modal').id));
});

document.getElementById('nav-theme')?.addEventListener('click', ()=>openModal('themeModal'));
document.querySelectorAll('#themeModal .option-item').forEach(b=>{
    b.addEventListener('click', ()=>{
        localStorage.setItem(KEYS.THEME, b.getAttribute('data-theme'));
        setHtmlTheme(localStorage.getItem(KEYS.THEME)||'default');
        closeModal('themeModal');
    });
});
document.getElementById('nav-lang')?.addEventListener('click', ()=>{
    const cur = getLang();
    document.querySelectorAll('#langModal .lang-opt').forEach(x=>{
        x.classList.toggle('is-active', x.getAttribute('data-lang')===cur);
    });
    openModal('langModal');
});
document.querySelectorAll('#langModal .lang-opt').forEach(b=>{
    b.addEventListener('click', ()=>{
        localStorage.setItem(KEYS.LANG, b.getAttribute('data-lang'));
        applyI18n(getLang());
        closeModal('langModal');
    });
});

/* ================= Instruments ================= */
const INSTRUMENTS = {
    currencies: ["AED/CNY OTC","AUD/CAD OTC","AUD/USD OTC","BHD/CNY OTC","EUR/CHF OTC","EUR/NZD OTC","EUR/USD OTC","GBP/AUD OTC","LBP/USD OTC","NZD/JPY OTC","SAR/CNY OTC","UAH/USD OTC","USD/ARS OTC","USD/CAD OTC","USD/CLP OTC","USD/CNH OTC","USD/EGP OTC","USD/RUB OTC","ZAR/USD OTC","CHF/NOK OTC","EUR/HUF OTC","EUR/JPY OTC","EUR/RUB OTC","AUD/NZD OTC","AUD/BRL OTC","USD/COP OTC","USD/INR OTC","USD/SGD OTC","CAD/CHF OTC","QAR/CNY OTC","AUD/JPY OTC","OMR/CNY OTC","EUR/GBP OTC","USD/VND OTC","AUD/CHF OTC","USD/THB OTC","USD/DZD OTC","NGN/USD OTC","CAD/JPY OTC","TND/USD OTC","USD/BDT OTC","NZD/USD OTC","USD/MYR OTC","USD/PKR OTC","USD/MXN OTC","GBP/USD OTC","USD/PHP OTC","MAD/USD OTC","JOD/CNY OTC","GBP/JPY OTC","USD/CHF OTC","KES/USD OTC","USD/IDR OTC","CHF/JPY OTC","USD/JPY OTC"],
    crypto: ["Cardano OTC","Bitcoin ETF OTC","BNB OTC","Bitcoin OTC","Polkadot OTC","Ethereum OTC","Litecoin OTC","Polygon OTC","Avalanche OTC","TRON OTC","Toncoin OTC","Solana OTC","Chainlink OTC","Dogecoin OTC","Bitcoin"],
    stocks: ["Apple OTC","Boeing Company OTC","Intel OTC","Johnson & Johnson OTC","Microsoft OTC","Coinbase Global OTC","Marathon Digital Holdings OTC","FedEx OTC","Amazon OTC","VISA OTC","McDonald's OTC","Alibaba OTC","Advanced Micro Devices OTC","American Express OTC","ExxonMobil OTC","Palantir Technologies OTC","VIX OTC","Cisco OTC","Netflix OTC","FACEBOOK INC OTC","Pfizer Inc OTC","Citigroup Inc OTC","Tesla OTC","GameStop Corp OTC"],
    commodities: ["Brent Oil OTC","WTI Crude Oil OTC","Silver OTC","Gold OTC","Natural Gas OTC","Palladium spot OTC","Platinum spot OTC"],
    indices: ["AUS 200 OTC","100GBP OTC","D30EUR OTC","DJI30 OTC","E35EUR OTC","E50EUR OTC","F40EUR OTC","JPN225 OTC","US100 OTC","SP500 OTC"]
};
const catOrder = ["currencies","crypto","stocks","commodities","indices"];

function renderInstrumentsList(items){
    const list = document.getElementById('instrList');
    if (!list) return;
    list.innerHTML = "";
    items.forEach(name=>{
        const b = document.createElement('button');
        b.className='instr-item'; b.type='button'; b.textContent=name;
        b.addEventListener('click', ()=>{ setFieldValue('instrument', name); closeModal('instrumentsModal'); });
        list.appendChild(b);
    });
}
function activateCategory(cat){
    document.querySelectorAll('.instr-cat').forEach(btn=>btn.classList.toggle('is-active', btn.getAttribute('data-cat')===cat));
    renderInstrumentsList(INSTRUMENTS[cat]||[]);
}
function searchInstruments(q){
    const query = q.trim().toLowerCase();
    if (!query){
        const active = document.querySelector('.instr-cat.is-active')?.getAttribute('data-cat') || 'currencies';
        renderInstrumentsList(INSTRUMENTS[active]||[]);
        return;
    }
    const all = catOrder.flatMap(c=>INSTRUMENTS[c]||[]);
    renderInstrumentsList(all.filter(x=>x.toLowerCase().includes(query)));
}
(function initInstrumentsModal(){
    const field = document.getElementById('field-instrument');
    field?.addEventListener('click', ()=>openModal('instrumentsModal'));
    field?.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openModal('instrumentsModal'); }});
    document.querySelectorAll('.instr-cat').forEach(btn=>btn.addEventListener('click', ()=>{
        activateCategory(btn.getAttribute('data-cat'));
        const s = document.getElementById('instrSearch'); if (s) s.value="";
    }));
    document.getElementById('instrSearch')?.addEventListener('input', e=>searchInstruments(e.target.value));
    activateCategory('currencies');
})();

/* ================= Expiration ================= */
const EXPIRES = ['S5','S15','S30','M1','M3','M5','M30','H1','H4'];
(function initExpire(){
    const field = document.getElementById('field-expiration');
    const list  = document.getElementById('expList');
    function draw(selected){
        if (!list) return;
        list.innerHTML="";
        EXPIRES.forEach(v=>{
            const b=document.createElement('button');
            b.className='exp-item'+(v===selected?' is-active':''); b.type='button'; b.textContent=v;
            b.addEventListener('click', ()=>{ setFieldValue('expiration', v); closeModal('expireModal'); });
            list.appendChild(b);
        });
    }
    function open(){ draw(getField('expiration')); openModal('expireModal'); }
    field?.addEventListener('click', open);
    field?.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); open(); }});
})();

/* ================= Fields & persistence ================= */
function getFields(){ try{ return JSON.parse(localStorage.getItem(KEYS.FIELDS)||'{}'); }catch(e){ return {}; } }
function saveFields(o){ localStorage.setItem(KEYS.FIELDS, JSON.stringify(o||{})); }
function setFieldValue(kind, value){
    const map = { instrument:['#field-instrument','ph.select_instrument'], expiration:['#field-expiration','ph.expiration_time'] };
    const el = document.querySelector(map[kind]?.[0]); if (!el) return;
    el.setAttribute('data-value', value);
    el.querySelector('.ui-field__placeholder').textContent = value;
    const f=getFields(); f[kind]=value; saveFields(f);
    updateStartState();
}
function getField(kind){ return getFields()[kind]||''; }
function clearFields(){
    saveFields({});
    const d=t();
    const fi = document.querySelector('#field-instrument .ui-field__placeholder');
    if (fi) fi.textContent = d['ph.select_instrument'];
    const fe = document.querySelector('#field-expiration .ui-field__placeholder');
    if (fe) fe.textContent = d['ph.expiration_time'];
    document.getElementById('field-instrument')?.removeAttribute('data-value');
    document.getElementById('field-expiration')?.removeAttribute('data-value');
}

/* ================= Stats ================= */
function loadStats(){ try{ return JSON.parse(localStorage.getItem(KEYS.STATS)||'{}'); }catch(e){ return {}; } }
function saveStats(s){ localStorage.setItem(KEYS.STATS, JSON.stringify(s||{})); }
function addSignalToStats(acc){
    const s=loadStats(); s.count=(s.count||0)+1; s.sumAcc=(s.sumAcc||0)+(+acc||0); saveStats(s);
}
function openStatsModal(){
    const s=loadStats(); const count=s.count||0; const avg=count?(s.sumAcc/count):0;
    document.getElementById('stTariff')?.replaceChildren(document.createTextNode('Platinum'));
    document.getElementById('stCount')?.replaceChildren(document.createTextNode(count));
    document.getElementById('stAvg')?.replaceChildren(document.createTextNode(`${Math.round(avg)}%`));
    openModal('statsModal');
}
document.getElementById('nav-stats')?.addEventListener('click', openStatsModal);

/* ================= Helpers ================= */
function msToMoscowTimeString(date){
    try{
        return date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit', timeZone:'Europe/Moscow'});
    }catch(e){
        return date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }
}
function randomDir(){ return Math.random() < 0.5 ? 'UP' : 'DOWN'; }
function isAllSelected(){ return !!(getField('instrument') && getField('expiration')); }

/* ================= Signal States ================= */
function scrollToSignal(){
    const card=document.getElementById('vipSignal'); if(!card) return;
    const y = card.getBoundingClientRect().top + window.scrollY - 8;
    window.scrollTo({ top:y, behavior:'smooth' });
}
function showState(state){
    const controls=document.getElementById('controls');
    const idle   =document.getElementById('idleView');
    const steps  =document.getElementById('analysisSteps');
    const res    =document.getElementById('resultView');
    const reset  =document.getElementById('resetWrap');

    if(state==='start'){
        controls?.classList.remove('collapsed'); if(idle) idle.hidden=false; if(steps) steps.hidden=true; if(res) res.hidden=true; if(reset) reset.hidden=true;
    }else if(state==='analyzing'){
        controls?.classList.add('collapsed'); if(idle) idle.hidden=true; if(steps) steps.hidden=false; if(res) res.hidden=true; if(reset) reset.hidden=true;
        scrollToSignal();
    }else if(state==='result'){
        controls?.classList.add('collapsed'); if(idle) idle.hidden=true; if(steps) steps.hidden=true;
        if(res){ res.hidden=false; res.classList.remove('result-enter'); requestAnimationFrame(()=>res.classList.add('result-enter')); }
        if(reset) reset.hidden=false;
    }
}

/* ================= Smooth analysis ================= */
function randomAnalyzeDuration(){ // ~3.5s – 6.5s
    return Math.floor(3500 + Math.random()*3000);
}

function runAnalysisSmooth(totalMs, onDone){
    const bar = document.getElementById('progressBar');
    const txt = document.getElementById('progressText');
    const steps = Array.from(document.querySelectorAll('.step')); // data-step=1..4
    steps.forEach(s=>s.classList.remove('done'));
    if (bar) bar.style.width='0%';
    if (txt) txt.textContent='0%';

    const labels = [t()['progress.step1'], t()['progress.step2'], t()['progress.step3'], t()['progress.step4']];
    const start = performance.now();
    const thresholds = [0.25, 0.5, 0.75, 1.0];
    const done = [false,false,false,false];

    function frame(now){
        const elapsed = now - start;
        const k = Math.min(1, elapsed / totalMs);
        const pct = Math.floor(k * 100);

        // ширина и подпись
        if (bar) bar.style.width = pct + '%';
        const idx = Math.min(3, Math.floor(k * 4)); // 0..3
        if (txt) txt.textContent = `${pct}% • ${labels[idx] || t()['progress.analyzing']}`;

        // отмечаем шаги как законченные
        thresholds.forEach((thr,i)=>{
            if (!done[i] && k >= thr){
                done[i] = true;
                const el = document.querySelector(`.step[data-step="${i+1}"]`);
                el?.classList.add('done');
            }
        });

        if (k < 1){
            requestAnimationFrame(frame);
        } else {
            if (bar) bar.style.width = '100%';
            if (txt) txt.textContent = `100% • ${labels[3]}`;
            setTimeout(()=> onDone && onDone(), 380);
        }
    }
    requestAnimationFrame(frame);
}

/* ================= Result ================= */
function saveSignal(o){ localStorage.setItem(KEYS.SIGNAL, JSON.stringify(o||{})); }
function loadSignal(){ try{ return JSON.parse(localStorage.getItem(KEYS.SIGNAL)||'{}'); }catch(e){ return {}; } }

function showResult(){
    const pair = getField('instrument');
    const exp  = getField('expiration');
    const dir  = randomDir();
    const conf = Math.floor(75 + Math.random()*21);      // 75..95
    const strength = Math.random()<0.55 ? 'Medium' : 'High';
    const acc  = (87 + Math.random()*11).toFixed(0);     // 87..98
    const plus = Math.random()<0.5 ? 1 : 2;              // +1–2 min
    const valid = msToMoscowTimeString(new Date(Date.now()+plus*60000));

    const arrow=document.getElementById('dirArrow');
    const dirTxt=document.getElementById('dirText');
    arrow?.classList.remove('up','down'); dirTxt?.classList.remove('up','down');
    if (dir==='UP'){ arrow?.classList.add('up'); dirTxt?.classList.add('up'); } else { arrow?.classList.add('down'); dirTxt?.classList.add('down'); }
    if (dirTxt) dirTxt.textContent = dir;

    document.getElementById('resTime')?.replaceChildren(document.createTextNode(exp || '—'));
    document.getElementById('resPair')?.replaceChildren(document.createTextNode(pair || '—'));
    document.getElementById('resConf')?.replaceChildren(document.createTextNode(`${conf}%`));
    document.getElementById('resStrength')?.replaceChildren(document.createTextNode(strength));
    document.getElementById('resValid')?.replaceChildren(document.createTextNode(valid));
    document.getElementById('resAcc')?.replaceChildren(document.createTextNode(`${acc}%`));

    addSignalToStats(+acc);
    saveSignal({pair,exp,dir,conf,strength,valid,acc});
    showState('result');
}

/* ================= Controls ================= */
const startBtn = document.getElementById('vipStartBtn');
function updateStartState(){ if (startBtn) startBtn.disabled = !isAllSelected(); }

startBtn?.addEventListener('click', ()=>{
    if (!isAllSelected()) return;
    showState('analyzing');
    runAnalysisSmooth(randomAnalyzeDuration(), showResult);
});

document.getElementById('repeatBtn')?.addEventListener('click', ()=>{
    if (!isAllSelected()) return;
    showState('analyzing');
    runAnalysisSmooth(randomAnalyzeDuration(), showResult);
});

function resetAll(){
    localStorage.removeItem(KEYS.SIGNAL);
    document.querySelectorAll('.step').forEach(s=>s.classList.remove('done'));
    const bar=document.getElementById('progressBar'); if (bar) bar.style.width='0%';
    const txt=document.getElementById('progressText'); if (txt) txt.textContent='0%';
    clearFields();
    updateStartState();
    showState('start');
}
document.getElementById('resetBtn')?.addEventListener('click', resetAll);

/* ================= Bottom Sheet (Welcome) ================= */
function openSheet(id){ document.getElementById(id)?.classList.add('open'); }
function closeSheet(id){ document.getElementById(id)?.classList.remove('open'); }

(function initVipWelcome(){
    const sheet = document.getElementById('vipWelcome');
    if (!sheet) return;

    document.getElementById('vipWelcomeBtn')?.addEventListener('click', ()=>{
        localStorage.setItem(KEYS.WELCOME_SHOWN,'1'); closeSheet('vipWelcome');
    });
    sheet.querySelector('[data-sheet-close]')?.addEventListener('click', ()=>{
        localStorage.setItem(KEYS.WELCOME_SHOWN,'1'); closeSheet('vipWelcome');
    });
    document.addEventListener('keydown', (e)=>{
        if (e.key==='Escape' && sheet.classList.contains('open')){
            localStorage.setItem(KEYS.WELCOME_SHOWN,'1'); closeSheet('vipWelcome');
        }
    });
})();

/* ================= Restore ================= */
function restore(){
    setHtmlTheme(localStorage.getItem(KEYS.THEME)||'default');
    applyI18n(getLang());

    if (!localStorage.getItem(KEYS.WELCOME_SHOWN)){
        setTimeout(()=> openSheet('vipWelcome'), 250);
    }

    showState('start');

    const f=getFields();
    if (f.instrument) setFieldValue('instrument', f.instrument);
    if (f.expiration) setFieldValue('expiration', f.expiration);
    updateStartState();

    const s = loadSignal();
    if (s?.pair){
        const arrow=document.getElementById('dirArrow');
        const dirTxt=document.getElementById('dirText');
        const dir = s.dir || 'UP';
        arrow?.classList.remove('up','down'); dirTxt?.classList.remove('up','down');
        if (dir==='UP'){ arrow?.classList.add('up'); dirTxt?.classList.add('up'); } else { arrow?.classList.add('down'); dirTxt?.classList.add('down'); }
        if (dirTxt) dirTxt.textContent = dir;

        document.getElementById('resTime')?.replaceChildren(document.createTextNode(s.exp || '—'));
        document.getElementById('resPair')?.replaceChildren(document.createTextNode(s.pair || '—'));
        document.getElementById('resConf')?.replaceChildren(document.createTextNode((s.conf??'—') + (s.conf!=null?'%':'')));
        document.getElementById('resStrength')?.replaceChildren(document.createTextNode(s.strength || '—'));
        document.getElementById('resValid')?.replaceChildren(document.createTextNode(s.valid || '—'));
        document.getElementById('resAcc')?.replaceChildren(document.createTextNode((s.acc??'—') + (s.acc!=null?'%':'')));

        showState('result');
    }
}

/* ================= Init ================= */
restore();
