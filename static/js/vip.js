/* ================= i18n ================= */
const I18N = {
    en: {
        "menu.title":"Menu","menu.stats":"Your Statistics","menu.language":"Choose Language","menu.theme":"Theme",
        "btn.close":"Close","btn.generate":"Generate signal","btn.reset":"Reset","btn.repeat":"Repeat",
        "label.select_instrument":"Select instrument","ph.select_instrument":"Select instrument",
        "label.select_model":"Model","label.expiration_time":"Expiration time","ph.expiration_time":"Select the time of the transaction",
        "instr.title":"Select instrument","instr.categories":"CATEGORIES","instr.currencies":"Currencies","instr.crypto":"Cryptocurrencies","instr.stocks":"Stocks","instr.commodities":"Commodities","instr.indices":"Indices",
        "expire.title":"Expiration time","signal.title":"Signal",
        "vip.idle":"Tap “Generate signal”",
        "vip.ta":"Technical analysis","vip.ta_sub":"Indicators & S/R",
        "vip.patterns":"Patterns recognition","vip.patterns_sub":"Trends & figures",
        "vip.math":"Mathematical calculations","vip.math_sub":"Probabilities & risks",
        "vip.generation":"Signal generation","vip.generation_sub":"Final assembling",
        "welcome.title": "Welcome, Platinum!",
        "welcome.text": "You are now a Platinum client. Thanks for being with us! Enjoy higher accuracy, trade wisely and use your status benefits.",
        "welcome.cta": "Continue", "modal.q": "Model: TESSA Quantum",
        "vip.market":"Market:","vip.time":"Time:","vip.pair":"Pair:","vip.confidence":"Confidence:","vip.strength":"Strength:","vip.valid_until":"Valid until:",
        "vip.accuracy":"accuracy","vip.volume":"volume","vip.risk":"risk",
        "stats.title":"Your Statistics","stats.tariff":"Your tariff:","stats.received":"Signals received:","stats.accuracy":"Signal accuracy:"
    },
    ru: {
        "menu.title":"Меню","menu.stats":"Ваша статистика","menu.language":"Выбор языка","menu.theme":"Тема",
        "btn.close":"Закрыть","btn.generate":"Сгенерировать сигнал","btn.reset":"Сбросить","btn.repeat":"Повторить",
        "label.select_instrument":"Выберите инструмент","ph.select_instrument":"Выберите инструмент",
        "label.select_model":"Модель","label.expiration_time":"Время экспирации","ph.expiration_time":"Выберите время сделки",
        "instr.title":"Выберите инструмент","instr.categories":"КАТЕГОРИИ","instr.currencies":"Валюты","instr.crypto":"Криптовалюты","instr.stocks":"Акции","instr.commodities":"Сырьё","instr.indices":"Индексы",
        "expire.title":"Время экспирации","signal.title":"Сигнал",
        "vip.idle":"Нажмите «Сгенерировать сигнал»", "modal.q": "Модель: TESSA Quantum",
        "vip.ta":"Технический анализ","vip.ta_sub":"Индикаторы и уровни S/R",
        "vip.patterns":"Распознавание паттернов","vip.patterns_sub":"Тренды и фигуры",
        "vip.math":"Математические расчёты","vip.math_sub":"Вероятности и риски",
        "vip.generation":"Генерация сигнала","vip.generation_sub":"Финальная сборка",
        "welcome.title": "Добро пожаловать, Platinum!",
        "welcome.text": "Вы теперь Platinum-клиент. Спасибо, что с нами! Получайте более точные сигналы, торгуйте аккуратно и используйте преимущества вашего статуса.",
        "welcome.cta": "Продолжить",
        "vip.market":"Рынок:","vip.time":"Время:","vip.pair":"Пара:","vip.confidence":"Уверенность:","vip.strength":"Сила:","vip.valid_until":"Действует до:",
        "vip.accuracy":"точность","vip.volume":"объём","vip.risk":"риск",
        "stats.title":"Ваша статистика","stats.tariff":"Ваш тариф:","stats.received":"Сигналов получено:","stats.accuracy":"Средняя точность:"
    }

};

// ── Spanish (es)
I18N.es = {
    "menu.title":"Menú","menu.stats":"Tus estadísticas","menu.language":"Elegir idioma","menu.theme":"Tema",
    "btn.close":"Cerrar","btn.generate":"Generar señal","btn.reset":"Restablecer","btn.repeat":"Repetir",
    "label.select_instrument":"Seleccione instrumento","ph.select_instrument":"Seleccione instrumento",
    "label.select_model":"Modelo","label.expiration_time":"Tiempo de expiración","ph.expiration_time":"Seleccione el tiempo de la operación",
    "instr.title":"Seleccione instrumento","instr.categories":"CATEGORÍAS","instr.currencies":"Divisas","instr.crypto":"Criptomonedas","instr.stocks":"Acciones","instr.commodities":"Materias primas","instr.indices":"Índices",
    "expire.title":"Tiempo de expiración","signal.title":"Señal",
    "vip.idle":"Toque «Generar señal»","modal.q":"Modelo: TESSA Quantum",
    "vip.ta":"Análisis técnico","vip.ta_sub":"Indicadores y niveles S/R",
    "vip.patterns":"Reconocimiento de patrones","vip.patterns_sub":"Tendencias y figuras",
    "vip.math":"Cálculos matemáticos","vip.math_sub":"Probabilidades y riesgos",
    "vip.generation":"Generación de señal","vip.generation_sub":"Montaje final",
    "welcome.title":"¡Bienvenido, Platinum!",
    "welcome.text":"Ahora eres cliente Platinum. ¡Gracias por estar con nosotros! Disfruta de mayor precisión, opera con prudencia y usa tus beneficios.",
    "welcome.cta":"Continuar",
    "vip.market":"Mercado:","vip.time":"Tiempo:","vip.pair":"Par:","vip.confidence":"Confianza:","vip.strength":"Fuerza:","vip.valid_until":"Válido hasta:",
    "vip.accuracy":"precisión","vip.volume":"volumen","vip.risk":"riesgo",
    "stats.title":"Tus estadísticas","stats.tariff":"Tu tarifa:","stats.received":"Señales recibidas:","stats.accuracy":"Precisión media:"
};

// ── Hindi (hi)
I18N.hi = {
    "menu.title":"मेनू","menu.stats":"आपकी सांख्यिकी","menu.language":"भाषा चुनें","menu.theme":"थीम",
    "btn.close":"बंद करें","btn.generate":"सिग्नल जेनरेट करें","btn.reset":"रीसेट","btn.repeat":"दोहराएं",
    "label.select_instrument":"इंस्ट्रूमेंट चुनें","ph.select_instrument":"इंस्ट्रूमेंट चुनें",
    "label.select_model":"मॉडल","label.expiration_time":"एक्सपायरी समय","ph.expiration_time":"ट्रांज़ैक्शन का समय चुनें",
    "instr.title":"इंस्ट्रूमेंट चुनें","instr.categories":"श्रेणियाँ","instr.currencies":"मुद्राएँ","instr.crypto":"क्रिप्टोकरेंसी","instr.stocks":"शेयर","instr.commodities":"कमोडिटीज़","instr.indices":"सूचकांक",
    "expire.title":"एक्सपायरी समय","signal.title":"सिग्नल",
    "vip.idle":"«सिग्नल जेनरेट करें» दबाएँ","modal.q":"मॉडल: TESSA Quantum",
    "vip.ta":"टेक्निकल एनालिसिस","vip.ta_sub":"इंडिकेटर्स व S/R स्तर",
    "vip.patterns":"पैटर्न पहचान","vip.patterns_sub":"ट्रेंड्स व फिगर्स",
    "vip.math":"गणितीय गणनाएँ","vip.math_sub":"प्रायिकताएँ व जोखिम",
    "vip.generation":"सिग्नल जेनरेशन","vip.generation_sub":"फाइनल असेंबली",
    "welcome.title":"स्वागत है, Platinum!",
    "welcome.text":"अब आप Platinum क्लाइंट हैं। धन्यवाद! अधिक सटीक सिग्नल पाएँ, सावधानी से ट्रेड करें और अपने स्टेटस के लाभ लें।",
    "welcome.cta":"जारी रखें",
    "vip.market":"मार्केट:","vip.time":"समय:","vip.pair":"पेयर:","vip.confidence":"विश्वास:","vip.strength":"शक्ति:","vip.valid_until":"मान्य तक:",
    "vip.accuracy":"सटीकता","vip.volume":"वॉल्यूम","vip.risk":"जोखिम",
    "stats.title":"आपकी सांख्यिकी","stats.tariff":"आपका टैरिफ:","stats.received":"प्राप्त सिग्नल:","stats.accuracy":"औसत सटीकता:"
};


const KEYS = { THEME:"vip_theme", LANG:"vip_lang", FIELDS:"vip_fields", SIGNAL:"vip_signal", WELCOME_SHOWN: "vip_welcome_shown", STATS:"vip_stats" };

function getLang(){ return localStorage.getItem(KEYS.LANG) || 'ru'; }
function t(){ return I18N[getLang()] || I18N.ru; }
function applyI18n(lang){
    const d=I18N[lang]||I18N.en;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.getAttribute('data-i18n');
        if(!k||d[k]==null) return;
        if(/^(INPUT|TEXTAREA)$/.test(el.tagName)) el.setAttribute('placeholder', d[k]);
        else el.textContent = d[k];
    });
    // подписи результата (если без data-i18n)
    const subs=document.querySelectorAll('#resultView .badge-block .sub');
    if (subs[0]) subs[0].textContent = t()['vip.accuracy'];
    if (subs[1]) subs[1].textContent = t()['vip.volume'];
    const rk=document.querySelector('#resultView .risk-full .key');
    if (rk) rk.textContent = t()['vip.risk'];

    // шаги анализа
    setFirstText(['#step1Title','.step[data-step="1"] .title'], t()['vip.ta']);
    setFirstText(['#step1Sub',  '.step[data-step="1"] .sub']  , t()['vip.ta_sub']);
    setFirstText(['#step2Title','.step[data-step="2"] .title'], t()['vip.patterns']);
    setFirstText(['#step2Sub',  '.step[data-step="2"] .sub']  , t()['vip.patterns_sub']);
    setFirstText(['#step3Title','.step[data-step="3"] .title'], t()['vip.math']);
    setFirstText(['#step3Sub',  '.step[data-step="3"] .sub']  , t()['vip.math_sub']);
    setFirstText(['#step4Title','.step[data-step="4"] .title'], t()['vip.generation']);
    setFirstText(['#step4Sub',  '.step[data-step="4"] .sub']  , t()['vip.generation_sub']);

    // ключи результата
    setFirstText(['#labMarket','.res-market .key','[data-res-key="market"]'], t()['vip.market']);
    setFirstText(['#labTime',  '.res-time .key',  '[data-res-key="time"]'  ], t()['vip.time']);
    setFirstText(['#labPair',  '.res-pair .key',  '[data-res-key="pair"]'  ], t()['vip.pair']);
    setFirstText(['#labConf',  '.res-conf .key',  '[data-res-key="conf"]'  ], t()['vip.confidence']);
    setFirstText(['#labStr',   '.res-strength .key','[data-res-key="strength"]'], t()['vip.strength']);
    setFirstText(['#labValid', '.res-valid .key','[data-res-key="valid"]' ], t()['vip.valid_until']);
}

function getPreferredTheme(){
    try{ if(window.Telegram?.WebApp?.colorScheme) return window.Telegram.WebApp.colorScheme; }catch(e){}
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}
function setHtmlTheme(mode){
    const eff = (mode==='default') ? getPreferredTheme() : mode;
    document.documentElement.setAttribute('data-theme', eff);
    const logo = document.getElementById('logoImg');
    if (logo){
        logo.src = eff==='light' ? logo.getAttribute('data-src-light') : logo.getAttribute('data-src-dark');
    }
}

/* helpers */
function setFirstText(cands, text){
    for (const sel of cands){
        const el = typeof sel === 'string' ? document.querySelector(sel) : sel;
        if (el){ el.textContent = text; return true; }
    }
    return false;
}

/* ============== sidebar & modals ============== */
const burger=document.getElementById('burgerBtn');
const sidebar=document.getElementById('sidebar');
document.getElementById('closeSidebar')?.addEventListener('click',()=>sidebar.classList.remove('open'));
burger?.addEventListener('click',()=>sidebar.classList.add('open'));
document.addEventListener('click',e=>{
    if(sidebar.classList.contains('open') && !sidebar.contains(e.target) && !burger.contains(e.target)){
        sidebar.classList.remove('open');
    }
});
function openModal(id){ document.getElementById(id)?.classList.add('open'); }
function closeModal(id){ document.getElementById(id)?.classList.remove('open'); }
document.querySelectorAll('.modal [data-close-modal]').forEach(el=>{
    el.addEventListener('click',()=> closeModal(el.closest('.modal').id));
});
document.getElementById('nav-theme')?.addEventListener('click',()=>openModal('themeModal'));
document.querySelectorAll('#themeModal .option-item').forEach(b=>{
    b.addEventListener('click',()=>{
        localStorage.setItem(KEYS.THEME, b.getAttribute('data-theme'));
        setHtmlTheme(localStorage.getItem(KEYS.THEME)||'default');
        closeModal('themeModal');
    });
});
document.getElementById('nav-lang')?.addEventListener('click',()=>{
    const cur=getLang();
    document.querySelectorAll('#langModal .lang-opt').forEach(x=>x.classList.toggle('is-active', x.getAttribute('data-lang')===cur));
    openModal('langModal');
});
document.querySelectorAll('#langModal .lang-opt').forEach(b=>{
    b.addEventListener('click',()=>{
        localStorage.setItem(KEYS.LANG, b.getAttribute('data-lang'));
        applyI18n(getLang());
        const f=getFields();
        if(!f.instrument) document.querySelector('#field-instrument .ui-field__placeholder').textContent=t()['ph.select_instrument'];
        if(!f.expiration) document.querySelector('#field-expiration .ui-field__placeholder').textContent=t()['ph.expiration_time'];
        closeModal('langModal');
    });
});

/* ============== Instruments ============== */
const INSTRUMENTS = {
    currencies: ["AED/CNY OTC","AUD/CAD OTC","AUD/USD OTC","BHD/CNY OTC","EUR/CHF OTC","EUR/NZD OTC","EUR/USD OTC","GBP/AUD OTC","LBP/USD OTC","NZD/JPY OTC","SAR/CNY OTC","UAH/USD OTC","USD/ARS OTC","USD/CAD OTC","USD/CLP OTC","USD/CNH OTC","USD/EGP OTC","USD/RUB OTC","ZAR/USD OTC","CHF/NOK OTC","EUR/HUF OTC","EUR/JPY OTC","EUR/RUB OTC","AUD/NZD OTC","AUD/BRL OTC","USD/COP OTC","USD/INR OTC","USD/SGD OTC","CAD/CHF OTC","QAR/CNY OTC","AUD/JPY OTC","OMR/CNY OTC","EUR/GBP OTC","USD/VND OTC","AUD/CHF OTC","USD/THB OTC","USD/DZD OTC","NGN/USD OTC","CAD/JPY OTC","TND/USD OTC","USD/BDT OTC","NZD/USD OTC","USD/MYR OTC","USD/PKR OTC","USD/MXN OTC","GBP/USD OTC","USD/PHP OTC","MAD/USD OTC","JOD/CNY OTC","GBP/JPY OTC","USD/CHF OTC","KES/USD OTC","USD/IDR OTC","CHF/JPY OTC","USD/JPY OTC"],
    crypto: ["Cardano OTC","Bitcoin ETF OTC","BNB OTC","Bitcoin OTC","Polkadot OTC","Ethereum OTC","Litecoin OTC","Polygon OTC","Avalanche OTC","TRON OTC","Toncoin OTC","Solana OTC","Chainlink OTC","Dogecoin OTC","Bitcoin"],
    stocks: ["Apple OTC","Boeing Company OTC","Intel OTC","Johnson & Johnson OTC","Microsoft OTC","Coinbase Global OTC","Marathon Digital Holdings OTC","FedEx OTC","Amazon OTC","VISA OTC","McDonald's OTC","Alibaba OTC","Advanced Micro Devices OTC","American Express OTC","ExxonMobil OTC","Palantir Technologies OTC","VIX OTC","Cisco OTC","Netflix OTC","FACEBOOK INC OTC","Pfizer Inc OTC","Citigroup Inc OTC","Tesla OTC","GameStop Corp OTC"],
    commodities: ["Brent Oil OTC","WTI Crude Oil OTC","Silver OTC","Gold OTC","Natural Gas OTC","Palladium spot OTC","Platinum spot OTC"],
    indices: ["AUS 200 OTC","100GBP OTC","D30EUR OTC","DJI30 OTC","E35EUR OTC","E50EUR OTC","F40EUR OTC","JPN225 OTC","US100 OTC","SP500 OTC"]
};
const catOrder = ["currencies","crypto","stocks","commodities","indices"];

function renderInstrumentsList(items){
    const list = document.getElementById('instrList');
    list.innerHTML = "";
    items.forEach(name=>{
        const b=document.createElement('button');
        b.className='instr-item'; b.type='button'; b.textContent=name;
        b.addEventListener('click',()=>{ setFieldValue('instrument', name); closeModal('instrumentsModal'); });
        list.appendChild(b);
    });
}
function activateCategory(cat){
    document.querySelectorAll('.instr-cat').forEach(btn=>btn.classList.toggle('is-active', btn.getAttribute('data-cat')===cat));
    renderInstrumentsList(INSTRUMENTS[cat]||[]);
}
function searchInstruments(q){
    const query=q.trim().toLowerCase();
    if(!query){
        const active=document.querySelector('.instr-cat.is-active')?.getAttribute('data-cat') || 'currencies';
        renderInstrumentsList(INSTRUMENTS[active]||[]);
        return;
    }
    const all = catOrder.flatMap(c=>INSTRUMENTS[c]);
    renderInstrumentsList(all.filter(x=>x.toLowerCase().includes(query)));
}
(function initInstrumentsModal(){
    const field=document.getElementById('field-instrument');
    field?.addEventListener('click',()=>openModal('instrumentsModal'));
    field?.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openModal('instrumentsModal'); }});
    document.querySelectorAll('.instr-cat').forEach(btn=>btn.addEventListener('click',()=>{
        activateCategory(btn.getAttribute('data-cat'));
        document.getElementById('instrSearch').value="";
    }));
    document.getElementById('instrSearch')?.addEventListener('input',e=>searchInstruments(e.target.value));
    activateCategory('currencies');
})();

/* ============== Expiration ============== */
const EXPIRES = ['S5','S15','S30','M1','M3','M5','M30','H1','H4'];
(function initExpire(){
    const field=document.getElementById('field-expiration');
    const list=document.getElementById('expList');
    function draw(selected){
        list.innerHTML="";
        EXPIRES.forEach(v=>{
            const b=document.createElement('button');
            b.className='exp-item'+(v===selected?' is-active':''); b.type='button'; b.textContent=v;
            b.addEventListener('click',()=>{ setFieldValue('expiration', v); closeModal('expireModal'); });
            list.appendChild(b);
        });
    }
    function open(){ draw(getField('expiration')); openModal('expireModal'); }
    field?.addEventListener('click', open);
    field?.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); open(); }});
})();

/* ============== Fields & persistence ============== */
function getFields(){ try{ return JSON.parse(localStorage.getItem(KEYS.FIELDS)||'{}'); }catch(e){ return {}; } }
function saveFields(o){ localStorage.setItem(KEYS.FIELDS, JSON.stringify(o||{})); }
function setFieldValue(kind, value){
    const map={ instrument:['#field-instrument','ph.select_instrument'], expiration:['#field-expiration','ph.expiration_time'] };
    const el=document.querySelector(map[kind]?.[0]); if(!el) return;
    el.setAttribute('data-value', value);
    el.querySelector('.ui-field__placeholder').textContent = value;
    const f=getFields(); f[kind]=value; saveFields(f);
    updateStartState();
}
function getField(kind){ return getFields()[kind]||''; }
function clearFields(){
    saveFields({});
    const d=t();
    document.querySelector('#field-instrument .ui-field__placeholder').textContent=d['ph.select_instrument'];
    document.querySelector('#field-expiration .ui-field__placeholder').textContent=d['ph.expiration_time'];
    document.querySelector('#field-instrument').removeAttribute('data-value');
    document.querySelector('#field-expiration').removeAttribute('data-value');
}

/* ============== Stats (VIP) ============== */
function loadStats(){ try{ return JSON.parse(localStorage.getItem(KEYS.STATS)||'{}'); }catch(e){ return {}; } }
function saveStats(s){ localStorage.setItem(KEYS.STATS, JSON.stringify(s||{})); }
function addSignalToStats(acc){
    const s=loadStats(); s.count=(s.count||0)+1; s.sumAcc=(s.sumAcc||0)+(+acc||0); saveStats(s);
}
function openStatsModal(){
    const s=loadStats(); const count=s.count||0; const avg=count?(s.sumAcc/count):0;
    document.getElementById('stTariff').textContent='Platinum';
    document.getElementById('stCount').textContent=count;
    document.getElementById('stAvg').textContent=`${Math.round(avg)}%`;
    openModal('statsModal');
}
document.getElementById('nav-stats')?.addEventListener('click', openStatsModal);

/* ============== Save/Load signal (FIX) ============== */
function saveSignal(o){ localStorage.setItem(KEYS.SIGNAL, JSON.stringify(o||{})); }
function loadSignal(){ try{ return JSON.parse(localStorage.getItem(KEYS.SIGNAL)||'{}'); }catch(e){ return {}; } }

/* ============== Helpers ============== */
function randomAnalyzeDuration(){ const min=3200, max=6500; const a=Math.random(), b=Math.random(); return Math.floor(min + ((a+b)/2)*(max-min)); }
function msToMoscowTimeString(date){ return date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit', timeZone:'Europe/Moscow'}); }
function randomDir(){ return Math.random()<0.5 ? 'UP' : 'DOWN'; }

/* ============== States ============== */
function scrollToSignal(){
    const card=document.getElementById('vipSignal'); if(!card) return;
    const y=card.getBoundingClientRect().top + window.scrollY - 8;
    window.scrollTo({ top:y, behavior:'smooth' });
}
function showState(state){
    const controls=document.getElementById('controls');
    const idle   =document.getElementById('idleView');
    const steps  =document.getElementById('analysisSteps');
    const res    =document.getElementById('resultView');
    const actions=document.getElementById('actionWrap') || document.getElementById('resetWrap');

    if(state==='start'){
        controls.classList.remove('collapsed'); idle.hidden=false; steps.hidden=true; res.hidden=true; if(actions) actions.hidden=true;
    }else if(state==='analyzing'){
        controls.classList.add('collapsed'); idle.hidden=true; steps.hidden=false; res.hidden=true; if(actions) actions.hidden=true;
        scrollToSignal();
    }else if(state==='result'){
        controls.classList.add('collapsed'); idle.hidden=true; steps.hidden=true; res.hidden=false; if(actions) actions.hidden=false;
        res.classList.remove('result-enter'); requestAnimationFrame(()=>res.classList.add('result-enter'));
    }
}

/* ============== Analysis flow (random time) ============== */
function runStepsAndFinish(totalMs, onDone){
    const steps = Array.from(document.querySelectorAll('.step'));
    const bar   = document.getElementById('progressBar');
    const txt   = document.getElementById('progressText');

    const n = steps.length || 4;
    const base = totalMs / n;
    const parts = Array.from({length:n},()=> base * (0.85 + Math.random()*0.3));
    const sum = parts.reduce((a,b)=>a+b,0);
    for (let i=0;i<n;i++) parts[i] = parts[i]*totalMs/sum;

    let i=0;
    function tick(){
        if (i>0) steps[i-1].classList.add('done');
        const progress = Math.min(100, Math.round((i/n)*100));
        if (bar) bar.style.width = progress + '%';
        if (txt) txt.textContent = progress + '%';

        if (i < n){
            const delay = parts[i++];
            setTimeout(tick, delay);
        } else {
            setTimeout(()=>{ if (bar) bar.style.width='100%'; if (txt) txt.textContent='100%'; onDone(); }, 300);
        }
    }
    steps.forEach(s=>s.classList.remove('done'));
    if (bar) bar.style.width='0%';
    if (txt) txt.textContent='0%';
    showState('analyzing');
    tick();
}

/* ============== Result ============== */
function showResult(){
    const pair=getField('instrument');
    const exp =getField('expiration');
    const dir=randomDir();
    const conf=Math.floor(75+Math.random()*21);
    const strength=Math.random()<0.55?'Medium':'High';
    const acc=(87+Math.random()*11).toFixed(0);
    const plusMin=Math.random()<0.5?1:2;
    const valid=msToMoscowTimeString(new Date(Date.now()+plusMin*60000));

    const arrow=document.getElementById('dirArrow'); const dirTxt=document.getElementById('dirText');
    arrow.classList.remove('up','down'); dirTxt.classList.remove('up','down');
    if(dir==='UP'){arrow.classList.add('up'); dirTxt.classList.add('up');} else {arrow.classList.add('down'); dirTxt.classList.add('down');}
    dirTxt.textContent=dir;

    document.getElementById('resTime').textContent=exp||'—';
    document.getElementById('resPair').textContent=pair||'—';
    document.getElementById('resConf').textContent=conf+'%';
    document.getElementById('resStrength').textContent=strength;
    document.getElementById('resValid').textContent=valid;
    document.getElementById('resAcc').textContent=acc+'%';

    const subs=document.querySelectorAll('#resultView .badge-block .sub');
    if (subs[0]) subs[0].textContent = t()['vip.accuracy'];
    if (subs[1]) subs[1].textContent = t()['vip.volume'];
    const rk=document.querySelector('#resultView .risk-full .key');
    if (rk) rk.textContent = t()['vip.risk'];

    addSignalToStats(+acc);
    saveSignal({pair,exp,dir,conf,strength,valid,acc});
    showState('result');
}

/* ============== Start/Repeat/Reset ============== */
const startBtn=document.getElementById('vipStartBtn');
function updateStartState(){ startBtn && (startBtn.disabled = !(getField('instrument') && getField('expiration'))); }

startBtn?.addEventListener('click', ()=>{
    if(!(getField('instrument') && getField('expiration'))) return;
    runStepsAndFinish(randomAnalyzeDuration(), showResult);
});
document.getElementById('repeatBtn')?.addEventListener('click', ()=>{
    if(!(getField('instrument') && getField('expiration'))) return;
    runStepsAndFinish(randomAnalyzeDuration(), showResult);
});

function resetAll(){
    localStorage.removeItem(KEYS.SIGNAL);
    document.querySelectorAll('.step').forEach(s=>s.classList.remove('done'));
    document.getElementById('progressBar').style.width='0%';
    document.getElementById('progressText').textContent='0%';
    clearFields();
    updateStartState();
    const actions=document.getElementById('actionWrap') || document.getElementById('resetWrap');
    if (actions) actions.hidden = true;
    showState('start');
}
document.getElementById('resetBtn')?.addEventListener('click', resetAll);

/* bottom sheet welcome */
function openSheet(id){ document.getElementById(id)?.classList.add('open'); }
function closeSheet(id){ document.getElementById(id)?.classList.remove('open'); }

(function initVipWelcome(){
    const sheet = document.getElementById('vipWelcome');
    if (!sheet) return;
    document.getElementById('vipWelcomeBtn')?.addEventListener('click', ()=>{
        localStorage.setItem(KEYS.WELCOME_SHOWN, '1');
        closeSheet('vipWelcome');
    });
    sheet.querySelector('[data-sheet-close]')?.addEventListener('click', ()=>{
        localStorage.setItem(KEYS.WELCOME_SHOWN, '1');
        closeSheet('vipWelcome');
    });
    document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && sheet.classList.contains('open')){
            localStorage.setItem(KEYS.WELCOME_SHOWN, '1');
            closeSheet('vipWelcome');
        }
    });
})();

/* ============== Restore ============== */
function restore(){
    setHtmlTheme(localStorage.getItem(KEYS.THEME)||'default');
    applyI18n(getLang());

    if (!localStorage.getItem(KEYS.WELCOME_SHOWN)) {
        setTimeout(()=> openSheet('vipWelcome'), 250);
    }

    showState('start');

    const f=getFields();
    if(f.instrument) setFieldValue('instrument', f.instrument);
    if(f.expiration) setFieldValue('expiration', f.expiration);
    updateStartState();

    const s=loadSignal();
    if(s?.pair){
        document.getElementById('resTime').textContent = s.exp||'—';
        document.getElementById('resPair').textContent = s.pair||'—';
        document.getElementById('resConf').textContent = (s.conf||'—') + (s.conf?'%':'');
        document.getElementById('resStrength').textContent = s.strength||'—';
        document.getElementById('resValid').textContent = s.valid||'—';
        document.getElementById('resAcc').textContent = (s.acc||'—') + (s.acc?'%':'');

        const arrow=document.getElementById('dirArrow'); const dirTxt=document.getElementById('dirText');
        const dir=s.dir||'UP'; arrow.classList.remove('up','down'); dirTxt.classList.remove('up','down');
        if(dir==='UP'){arrow.classList.add('up'); dirTxt.classList.add('up');} else {arrow.classList.add('down'); dirTxt.classList.add('down');}
        dirTxt.textContent=dir;

        const actions=document.getElementById('actionWrap') || document.getElementById('resetWrap');
        if (actions) actions.hidden = false;

        showState('result');
    }
}

/* ============== Init ============== */
restore();
